___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "displayName": "E-Commerce Taboola pixel",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Taboola",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Taboola\u0027s e-Commerce pixel template enables you to configure e-Commerce related events such as purchase, add to cart \u0026 product view events as part of the Taboola pixel.",
  "categories": [
    "MARKETING",
    "CONVERSION_TRACKING",
    "ADVERTISING"
  ],
  "containerContexts": [
    "WEB"
  ],
  "securityGroups": []
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "accountId",
    "displayName": "Taboola Account ID",
    "simpleValueType": true,
    "help": "Enter here the Taboola Account ID. For any questions, please contact your Account Manager."
  },
  {
    "type": "TEXT",
    "name": "campaignIds",
    "displayName": "Campaign Ids",
    "simpleValueType": true,
    "help": "(Optional) Enter the Taboola Campaign ID, or IDs in case this event is relevant to more than one campaign. For any questions, please contact your Account Manager."
  },
  {
    "type": "CHECKBOX",
    "name": "enhancedEcomm",
    "checkboxText": "Use Enhanced Ecommerce",
    "simpleValueType": true,
    "help": "Select this option if you have a Google Enhance Ecommerce data layer installed on your site. When this option is selected, the required parameters will be collected from the data layer."
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "Event Type",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "PAGE_VIEW",
        "displayValue": "Base Pixel - Page View"
      },
      {
        "value": "ADD_TO_CART",
        "displayValue": "Add To Cart"
      },
      {
        "value": "REMOVE_FROM_CART",
        "displayValue": "Remove From Cart"
      },
      {
        "value": "ADD_TO_WISH_LIST",
        "displayValue": "Add To Wish List"
      },
      {
        "value": "REMOVE_FROM_WISH_LIST",
        "displayValue": "Remove From Wish List"
      },
      {
        "value": "PRODUCT_VIEW",
        "displayValue": "Product View"
      },
      {
        "value": "CATEGORY_VIEW",
        "displayValue": "Category View"
      },
      {
        "value": "HOME_PAGE_VISIT",
        "displayValue": "Home Page Visit"
      },
      {
        "value": "SEARCH",
        "displayValue": "Search"
      },
      {
        "value": "PURCHASE",
        "displayValue": "Purchase"
      },
      {
        "value": "CHECKOUT",
        "displayValue": "Checkout"
      }
    ],
    "simpleValueType": true,
    "subParams": [
      {
        "type": "SELECT",
        "name": "category",
        "displayName": "Category",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Select the GTM Variable that return the name of the category being viewed. Example: “Womens Shoes”",
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "CATEGORY_VIEW",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "categoryId",
        "displayName": "Category Id (Optional)",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Select the GTM Variable that return the ID of the category being viewed",
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "CATEGORY_VIEW",
            "type": "EQUALS"
          }
        ],
        "notSetText": "None"
      },
      {
        "type": "CHECKBOX",
        "name": "sendCategoryProductIds",
        "checkboxText": "Send product ids",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "CATEGORY_VIEW",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "productIds",
        "displayName": "Product IDs",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "ADD_TO_CART",
            "type": "EQUALS"
          },
          {
            "paramName": "eventType",
            "paramValue": "REMOVE_FROM_CART",
            "type": "EQUALS"
          },
          {
            "paramName": "eventType",
            "paramValue": "ADD_TO_WISH_LIST",
            "type": "EQUALS"
          },
          {
            "paramName": "eventType",
            "paramValue": "REMOVE_FROM_WISH_LIST",
            "type": "EQUALS"
          },
          {
            "paramName": "eventType",
            "paramValue": "PRODUCT_VIEW",
            "type": "EQUALS"
          },
          {
            "paramName": "eventType",
            "paramValue": "SEARCH",
            "type": "EQUALS"
          },
          {
            "paramName": "eventType",
            "paramValue": "CHECKOUT",
            "type": "EQUALS"
          },
          {
            "paramName": "sendCategoryProductIds",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "help": "Select the GTM Variable that returns Product IDs (SKUs) in the current page. Example: [“sku1”, “sku2”]"
      },
      {
        "type": "SELECT",
        "name": "searchTerm",
        "displayName": "Search Term",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "The string entered by the user for the search. Example: “long dress”",
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "SEARCH",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "cartDetails",
        "displayName": "Cart Details",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Select the GTM Variable that returns an array containing the quantity, product ID and the unit price of each item in the user\u0027s cart. Example:\n[{productId: \u0027sku1\u0027, quantity: 3, price: 22.45}, {productId: \u0027sku2\u0027, quantity: 4, price: 15.76}]",
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "PURCHASE",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "currency",
        "displayName": "Currency",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "PURCHASE",
            "type": "EQUALS"
          }
        ],
        "help": "The currency used in the cart in ISO 3-letter currency code notation. Example: “USD”"
      },
      {
        "type": "SELECT",
        "name": "value",
        "displayName": "Value",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "PURCHASE",
            "type": "EQUALS"
          }
        ],
        "help": "The total value of the purchase (conversion) in the given currency.  Example: 9.99"
      },
      {
        "type": "SELECT",
        "name": "orderId",
        "displayName": "Order Id",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "PURCHASE",
            "type": "EQUALS"
          }
        ],
        "help": "Select the GTM Variable that return the Order ID of the current transaction. This ID should be unique per Order."
      },
      {
        "type": "SELECT",
        "name": "custType",
        "displayName": "Customer Type (Optional)",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "PURCHASE",
            "type": "EQUALS"
          }
        ],
        "help": "The customer type, where 0 means this visitor is an existing customer; 1 means this visitor is a new customer",
        "notSetText": "None"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "enhancedEcomm",
        "paramValue": false,
        "type": "EQUALS"
      }
    ],
    "help": "Choose the event type. NOTE that you shouldn\u0027t choose \"Base Pixel - Page View\" in case that you have already implemented on your website \"Taboola pixel\" template with \"Base Pixel\" event."
  },
  {
    "type": "SELECT",
    "name": "eventType_enhanced",
    "displayName": "Event Type",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "ADD_TO_CART",
        "displayValue": "Add To Cart"
      },
      {
        "value": "REMOVE_FROM_CART",
        "displayValue": "Remove From Cart"
      },
      {
        "value": "PRODUCT_VIEW",
        "displayValue": "Product View"
      },
      {
        "value": "PURCHASE",
        "displayValue": "Purchase"
      },
      {
        "value": "CHECKOUT",
        "displayValue": "Checkout"
      },
      {
        "value": "CATEGORY_VIEW",
        "displayValue": "Category View"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "enhancedEcomm",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "subParams": [
      {
        "type": "SELECT",
        "name": "categoryIdEnh",
        "displayName": "Category Id (Optional)",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Select the GTM Variable that return the ID of the category being viewed",
        "enablingConditions": [
          {
            "paramName": "eventType_enhanced",
            "paramValue": "CATEGORY_VIEW",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "unified_id",
    "displayName": "Hashed email",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "email",
    "displayName": "non hashed email",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require necessary APIs
const log = require('logToConsole');
const createQueue = require('createQueue');
const injectScript = require('injectScript');
const copyFromWindow = require('copyFromWindow');
const encodeUriComponent = require('encodeUriComponent');
const copyFromDataLayer = require('copyFromDataLayer');
const getType = require('getType');
const Object = require('Object');
const sha256 = require('sha256');


// Generate the global and local variables2
const initPixelPush = createQueue('__tfa_pixel_init');
const initPixel = copyFromWindow('__tfa_pixel_init');
const _tfa = createQueue('_tfa');
const accountId = data.accountId;

function hashEmail(email, additionalInfo, sendEvent) {
   
   sha256(email, (digest) => {
     additionalInfo.unified_id = digest;
        sendEvent(additionalInfo);
    }, (error)=>{
        additionalInfo.emailHashFailed = "true";
        sendEvent(additionalInfo);
    }, {outputEncoding: 'hex'});
}

function getAdditionalInfo(sendEvent) {
  let additionalInfo = {};
  const ecomm = copyFromDataLayer('ecommerce') || {};
  if (ecomm.custType) additionalInfo.custType = ecomm.custType;
  if (data.custType) additionalInfo.custType = data.custType;
  if (data.unified_id) additionalInfo.unified_id = data.unified_id;
  if (data.email) {
      hashEmail(data.email, additionalInfo, sendEvent);
  } else {
      if (!Object.keys(additionalInfo).length) additionalInfo = null; 
      sendEvent(additionalInfo);
  }
}

// Handle base pixel - page view event
if (data.eventType === 'PAGE_VIEW') {
  // If page_view hasn't been sent for the ID yet, do it now
  if (initPixel.indexOf(accountId) === -1) {
    const pvParams = {
      notify: 'event',
      id: accountId,
      name: 'page_view'
    };
    getAdditionalInfo((additionalInfo) => {
        if (additionalInfo) pvParams.additionalInfo = additionalInfo;
        _tfa(pvParams);
    });
    initPixelPush(accountId);
  }
}
// Handle ecomm events
else {
  const params = {
    notify: 'ecevent',
    id: accountId,
    name:data.eventType || data.eventType_enhanced,
  };

  const mapProducts = products => {
    return products.map(i => {
         return {
           productId: i.id,
           quantity: i.quantity,
           price: i.price
         };
      });
  };

  const mapProductIds = products => {
   return products.map(i => {
        return i.id;
      });    
  };

  if (data.enhancedEcomm){
    const ecomm = copyFromDataLayer('ecommerce') || {}; 
  
    verifyMandatoryElements(data.eventType_enhanced, log, ecomm);
  
    if (data.eventType_enhanced === 'ADD_TO_CART' && ecomm.hasOwnProperty('add') && getType(ecomm.add.products) === 'array'){
      params.productIds = mapProductIds(ecomm.add.products);
    }
  
    if (data.eventType_enhanced === 'REMOVE_FROM_CART' && ecomm.hasOwnProperty('remove') && getType(ecomm.remove.products) === 'array') {
       params.productIds = mapProductIds(ecomm.remove.products);   
    }
  
    if(data.eventType_enhanced === 'PRODUCT_VIEW' && ecomm.hasOwnProperty('detail') && getType(ecomm.detail.products) === 'array') {
      params.productIds = [ecomm.detail.products[0].id];
    }
  
    if (data.eventType_enhanced === 'PURCHASE' && ecomm.hasOwnProperty('purchase')) {
      params.cartDetails = mapProducts(ecomm.purchase.products);
      params.currency = ecomm.currencyCode;
      params.value = ecomm.purchase.actionField.revenue;
      params.orderId = ecomm.purchase.actionField.id;
    }
  
    if (data.eventType_enhanced === 'CHECKOUT' && ecomm.hasOwnProperty('checkout')) {
      if(!ecomm.checkout.products) {
       return; // when the checkout step doesn't have products data
      }
      params.productIds = mapProductIds(ecomm.checkout.products);   
    } 
  
    if (data.eventType_enhanced === 'CATEGORY_VIEW' && ecomm.hasOwnProperty('impressions')) {
      params.productIds = mapProductIds(ecomm.impressions.slice(0,5));  
      params.category = ecomm.impressions[0].category;   
      if (data.categoryIdEnh) params.categoryId = data.categoryIdEnh;
    }
  }
  else {
    if (data.productIds) params.productIds = data.productIds;
    if (data.campaignIds) params.campaignIds = data.campaignIds;
    if (data.currency) params.currency = data.currency;
    if (data.orderId) params.orderId = data.orderId;
    if (data.categoryId) params.categoryId = data.categoryId;
    if (data.category) params.category = data.category;
    if (data.searchTerm) params.searchTerm = data.searchTerm;
    if (data.cartDetails) params.cartDetails = data.cartDetails;
    if (data.value) params.value = data.value;
  }
  getAdditionalInfo((additionalInfo) => {
      if (additionalInfo) {
          params.additionalInfo = additionalInfo;
      }
      _tfa(params);
  });
}

// Load the Taboola script if not already loaded
injectScript('https://cdn.taboola.com/libtrc/unip/' + encodeUriComponent(accountId) + '/tfa.js', data.gtmOnSuccess, data.gtmOnFailure, '_tfa_script');


// verify enhanced mandatory fields
function verifyMandatoryElements(eventType, log, ecommData) {
  if (isProductsMissing(eventType, ecommData)) {
    log('Error - mandatory field (products) is missing in Enhanced Ecommerce data layer for event type ' + eventType);
  }
  
  if (eventType === 'PURCHASE') {
   if (isNullOrEmpty(ecommData.purchase.actionField) || isNullOrEmpty(ecommData.purchase.actionField.id)) {
     log('Error - mandatory field (actionField.id) is missing in Enhanced Ecommerce data layer for event type PURCHASE');
   }
   if (isNullOrEmpty(ecommData.currencyCode)) {
     log('Error - mandatory field (currencyCode) is missing in Enhanced Ecommerce data layer for event type PURCHASE');
   }
   if (isNullOrEmpty(ecommData.purchase.actionField.revenue)) {
     log('Error - mandatory field (revenue) is missing in Enhanced Ecommerce data layer for event type PURCHASE');
   }
  }
  
  else if (eventType === 'CATEGORY_VIEW') {
    if (isNullOrEmpty(ecommData.impressions) || isNullOrEmpty(ecommData.impressions[0]) || isNullOrEmpty(ecommData.impressions[0].category)) {
    log('Error - mandatory field (impressions and/or category) is missing in Enhanced Ecommerce data layer for event type CATEGORY_VIEW');
    }
  }
  
  else {
    return true;
  }
}

function isProductsMissing (eventType, ecommData) {
  if ((eventType === 'ADD_TO_CART' && isNullOrEmpty(ecommData.add.products)) ||
     (eventType === 'REMOVE_FROM_CART' && isNullOrEmpty(ecommData.remove.products)) ||
     (eventType === 'PRODUCT_VIEW' && isNullOrEmpty(ecommData.detail.products[0].id)) ||
     (eventType === 'PURCHASE' && isNullOrEmpty(ecommData.purchase.products)) ||
     (eventType === 'CHECKOUT' && isNullOrEmpty(ecommData.checkout.products)) ||
     (eventType === 'CATEGORY_VIEW' && isNullOrEmpty(ecommData.impressions.slice(0,5)))) {
    return true;
  } else {
    return false;
  }
}

function isNullOrEmpty(val){
    return (val === undefined || val == null || val.length <= 0) ? true : false;
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_tfa"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__tfa_pixel_init"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.taboola.com/libtrc/unip/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ecommerce.*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: base pixel - page view
  code: "const mockData = {\n  enhancedEcomm: false,\n  eventType: 'PAGE_VIEW',\n\
    \  accountId: '1'\n};\n\nconst expected_params = {\n  notify: 'event',\n  id:\
    \ '1',\n  name: 'page_view'\n};\n\nmock('createQueue', (name) => {\n  if (name\
    \ === '__tfa_pixel_init') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params.id);\n\
    \    };\n  }\n  if (name === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\nmock('copyFromWindow', (name) => {\n  assertThat(name).isEqualTo('__tfa_pixel_init');\n\
    \  return [];\n});\n\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    // Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify that\
    \ the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\n\n"
- name: non-enhanced purchase
  code: "const mockData = {\n  enhancedEcomm: false,\n  eventType: 'PURCHASE',\n \
    \ accountId: '1',\n  custType: '1',\n  currency: 'USD',\n  cartDetails: [\n  \
    \ { productId: 'A123', \n     quantity: 5,\n     price: 999\n   }\n ]\n};\n\n\
    const expected_params = {\n  notify: 'ecevent',\n  id: '1',\n  name: 'PURCHASE',\n\
    \  currency: 'USD',\n  cartDetails: [\n   { productId: 'A123', \n     quantity:\
    \ 5,\n     price: 999\n   }\n ],\n  additionalInfo: {custType: '1'}\n};\n\nmock('createQueue',\
    \ (name) => {\n  if (name === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\nmock('copyFromWindow', (name) => {\n  assertThat(name).isEqualTo('__tfa_pixel_init');\n\
    \  return [];\n});\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: enhanced purchase
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'PURCHASE',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n       currencyCode: 'USD',\n  \
    \     purchase: {\n         actionField: {\n          id: '1111',\n          revenue:\
    \ 555  \n         },\n         products: [{ \n            name: 'taboola item',\
    \ \n            id: 'A123', \n            price: 999,\n            quantity: 5\n\
    \        }]\n       } \n  };\nmock('copyFromDataLayer', (key) => {\n  return dataLayer;\n\
    });\n\nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n  name: 'PURCHASE',\n\
    \  orderId: '1111',\n  currency: 'USD',\n  value: 555,\n  cartDetails: [\n   {\
    \ productId: 'A123', \n     quantity: 5,\n     price: 999\n   }\n ]\n};\n\nmock('createQueue',\
    \ (name) => {\n  if (name === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    // Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify that\
    \ the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\n\n"
- name: enhanced checkout
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'CHECKOUT',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      checkout: {\n         actionField:\
    \ {step: 1, //step number\n                        option: 'DHL' //step value\n\
    \                    },\n         products: [{ \n            name: 'taboola item',\
    \ \n            id: 'A123', \n            price: 999,\n            quantity: 5\n\
    \        }]\n       } \n  };\nmock('copyFromDataLayer', (key) => {\n  return dataLayer;\n\
    });\n\nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n  name: 'CHECKOUT',\n\
    \  productIds: ['A123']\n};\n\nmock('createQueue', (name) => {\n  if (name ===\
    \ '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: enhanced checkout - multiple
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'CHECKOUT',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      checkout: {\n         actionField:\
    \ {step: 1, //step number\n                        option: 'DHL' //step value\n\
    \                    },\n         products: [{ \n            name: 'taboola item',\
    \ \n            id: 'A123', \n            price: 999,\n            quantity: 5\n\
    \        },\n        { \n            name: 'taboola item2', \n            id:\
    \ 'B123', \n            price: 999,\n            quantity: 5\n        }]\n   \
    \    } \n  };\nmock('copyFromDataLayer', (key) => {\n  return dataLayer;\n});\n\
    \nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n  name: 'CHECKOUT',\n\
    \  productIds: ['A123', 'B123']\n};\nmock('sha256', (name, callback) => {callback(name\
    \ + '_hashed');});\nmock('createQueue', (name) => {\n  if (name === '_tfa') {\n\
    \    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: enhanced checkout - step 2 - ignore
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'CHECKOUT',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      checkout: {\n         actionField:\
    \ {step: 2, \n                        option: 'MasterCard' \n                \
    \    }\n       } \n  };\nmock('copyFromDataLayer', (key) => {\n  return dataLayer;\n\
    });\n\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n//\
    \ Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify that\
    \ the tag finished successfully.\nassertApi('injectScript').wasNotCalled();\n\n\
    \n"
- name: enhanced add to cart
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'ADD_TO_CART',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      add: {\n         actionField:\
    \ {\n          list: 'Shopping cart'\n          },\n         products: [{ \n \
    \           name: 'taboola item', \n            id: 'A123', \n            price:\
    \ 999,\n            quantity: 5\n        },\n        { \n            name: 'taboola\
    \ item2', \n            id: 'B123', \n            price: 999,\n            quantity:\
    \ 5\n        }]\n       } \n  };\nmock('copyFromDataLayer', (key) => {\n  return\
    \ dataLayer;\n});\n\nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n\
    \  name: 'ADD_TO_CART',\n  productIds: ['A123', 'B123']\n};\n\nmock('createQueue',\
    \ (name) => {\n  if (name === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: enhanced product view
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'PRODUCT_VIEW',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      detail: {\n         actionField:\
    \ { list: 'Search Results' },\n         products: [{ \n            name: 'taboola\
    \ item', \n            id: 'A123', \n            price: 999,\n            quantity:\
    \ 5\n        }]\n       } \n  };\nmock('copyFromDataLayer', (key) => {\n  return\
    \ dataLayer;\n});\n\nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n\
    \  name: 'PRODUCT_VIEW',\n  productIds: ['A123']\n};\n\nmock('createQueue', (name)\
    \ => {\n  if (name === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: enhanced category view
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'CATEGORY_VIEW',\n\
    \  accountId: '1',\n  categoryIdEnh: 123\n};\n\nconst dataLayer = {\n      impressions:\
    \ [{ \n            name: 'taboola item', \n            id: 'A123', \n        \
    \    price: 999,\n            quantity: 5,\n            category: 'taboola category'\n\
    \        }]\n  };\n\nmock('copyFromDataLayer', (key) => {\n  return dataLayer;\n\
    });\n\nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n  name: 'CATEGORY_VIEW',\n\
    \  productIds: ['A123'],\n  category: 'taboola category',\n  categoryId: 123\n\
    };\n\nmock('createQueue', (name) => {\n  if (name === '_tfa') {\n    return function(item)\
    \ {\n      assertThat(item).isEqualTo(expected_params);\n    };\n  } \n});\nmock('sha256',\
    \ (name, callback) => {callback(name + '_hashed');});\n\n// Call runCode to run\
    \ the template's code.\nrunCode(mockData);\n\n// Verify that the tag finished\
    \ successfully.\nassertApi('injectScript').wasCalled();\n\n\n"
- name: enhanced purchase missing mandatory fields
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'PURCHASE',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n       currencyCode: null,\n   \
    \    purchase: {\n         actionField: {\n          id: undefined,\n        \
    \  revenue: null  \n         },\n         products: []\n       } \n  };\nmock('copyFromDataLayer',\
    \ (key) => {\n  return dataLayer;\n});\n\nconst expected_params = {\n  notify:\
    \ 'ecevent',\n  id: '1',\n  name: 'PURCHASE',\n  currency: 'USD',\n  value: 555,\n\
    \  cartDetails: [\n   { productId: 'A123', \n     quantity: 5,\n     price: 999\n\
    \   }\n ]\n};\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('logToConsole').wasCalled(4);"
- name: enhanced category view missing mandatory fields
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'CATEGORY_VIEW',\n\
    \  accountId: '1',\n  categoryIdEnh: 123\n};\n\nconst dataLayer = {\n      impressions:\
    \ [{ \n            id: 'A123', \n            price: 999,\n            quantity:\
    \ 5,\n            category: null\n        }]\n  };\n\nmock('copyFromDataLayer',\
    \ (key) => {\n  return dataLayer;\n});\n\nconst expected_params = {\n  notify:\
    \ 'ecevent',\n  id: '1',\n  name: 'PURCHASE',\n  currency: 'USD',\n  value: 555,\n\
    \  cartDetails: [\n   { productId: 'A123', \n     quantity: 5,\n     price: 999\n\
    \   }\n ]\n};\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('logToConsole').wasCalled(1);"
- name: enhanced checkout missing mandatory fields
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'CHECKOUT',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      checkout: {\n         actionField:\
    \ {step: 1, //step number\n                        option: 'DHL' //step value\n\
    \                    },\n         products: []\n       } \n  };\nmock('copyFromDataLayer',\
    \ (key) => {\n  return dataLayer;\n});\nmock('sha256', (name, callback) => {callback(name\
    \ + '_hashed');});\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('logToConsole').wasCalled(1);"
- name: enhanced add to cart missing mandatory fields
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'ADD_TO_CART',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      add: {\n         actionField:\
    \ {\n          list: 'Shopping cart'\n          },\n         products: []\n  \
    \     } \n  };\nmock('copyFromDataLayer', (key) => {\n  return dataLayer;\n});\n\
    mock('sha256', (name, callback) => {callback(name + '_hashed');});\n\n// Call\
    \ runCode to run the template's code.\nrunCode(mockData);\n\n// Verify that the\
    \ tag finished successfully.\nassertApi('logToConsole').wasCalled(1);"
- name: base pixel -page view with custType
  code: "const mockData = {\n  enhancedEcomm: false,\n  eventType: 'PAGE_VIEW',\n\
    \  accountId: '1',\n  custType: '1'\n};\n\nconst expected_params = {\n  notify:\
    \ 'event',\n  id: '1',\n  name: 'page_view',\n  additionalInfo: {custType: '1'}\n\
    };\n\nmock('createQueue', (name) => {\n  if (name === '__tfa_pixel_init') {\n\
    \    return function(item) {\n      assertThat(item).isEqualTo(expected_params.id);\n\
    \    };\n  }\n  if (name === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\nmock('copyFromWindow', (name) => {\n  assertThat(name).isEqualTo('__tfa_pixel_init');\n\
    \  return [];\n});\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: base pixel page view with unified_id
  code: "const mockData = {\n  enhancedEcomm: false,\n  eventType: 'PAGE_VIEW',\n\
    \  accountId: '1',\n  unified_id: '123456'\n};\n\nconst expected_params = {\n\
    \  notify: 'event',\n  id: '1',\n  name: 'page_view',\n  additionalInfo:{unified_id:\
    \ '123456'}\n};\n\nmock('createQueue', (name) => {\n  if (name === '__tfa_pixel_init')\
    \ {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params.id);\n\
    \    };\n  }\n  if (name === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\nmock('copyFromWindow', (name) => {\n  assertThat(name).isEqualTo('__tfa_pixel_init');\n\
    \  return [];\n});\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: purchase with unified_id
  code: "const mockData = {\n  enhancedEcomm: false,\n  eventType: 'PURCHASE',\n \
    \ accountId: '1',\n  custType: '1',\n  currency: 'USD',\n  unified_id: \"123456\"\
    ,\n  cartDetails: [\n   { productId: 'A123', \n     quantity: 5,\n     price:\
    \ 999\n   }\n ]\n};\n\nconst expected_params = {\n  notify: 'ecevent',\n  id:\
    \ '1',\n  name: 'PURCHASE',\n  currency: 'USD',\n  cartDetails: [\n   { productId:\
    \ 'A123', \n     quantity: 5,\n     price: 999\n   }\n ],\n  additionalInfo: {custType:\
    \ '1', unified_id: \"123456\"}\n};\n\nmock('createQueue', (name) => {\n  if (name\
    \ === '_tfa') {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    };\n  } \n});\n\nmock('copyFromWindow', (name) => {\n  assertThat(name).isEqualTo('__tfa_pixel_init');\n\
    \  return [];\n});\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"
- name: Purchase with email no unified_id
  code: "const mockData = {\n  enhancedEcomm: false,\n  eventType: 'PURCHASE',\n \
    \ accountId: '1',\n  custType: '1',\n  currency: 'USD',\n  email: '123456789',\n\
    \  cartDetails: [\n   { productId: 'A123', \n     quantity: 5,\n     price: 999\n\
    \   }\n ]\n};\n\nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n\
    \  name: 'PURCHASE',\n  currency: 'USD',\n  cartDetails: [\n   { productId: 'A123',\
    \ \n     quantity: 5,\n     price: 999\n   }\n ],\n  additionalInfo: {custType:\
    \ '1', unified_id: \"123456789_hashed\"}\n};\n\nmock('createQueue', (name) =>\
    \ {\n    return function(item) {\n      assertThat(item).isEqualTo(expected_params);\n\
    \    }; \n});\n\nmock('copyFromWindow', (name) => {\n  assertThat(name).isEqualTo('__tfa_pixel_init');\n\
    \  return [];\n});\n\nmock('sha256', (name, callback) => {callback(name + '_hashed');});\n\
    \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalled();\n\
    \n\n"


___NOTES___

Created on 1/28/2020, 4:40:32 PM


